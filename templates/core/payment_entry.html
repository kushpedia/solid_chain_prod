{% extends 'base.html' %}

{% block title %}Record Payment - SolidChain{% endblock %}
{% load humanize %}
{% block content %}
<!-- Header -->
<div class="card-mobile mb-4">
    <div class="card-body-mobile">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h1 class="h4 fw-bold mb-1">Record Payment</h1>
                <p class="text-muted mb-0 text-small-mobile">
                    <i class="bi bi-cash-coin me-1"></i>
                    Treasurer-only payment recording
                </p>
            </div>
            <div>
                <span class="badge bg-danger p-2">
                    <i class="bi bi-shield-lock me-1"></i>
                    Staff Only
                </span>
            </div>
        </div>
    </div>
</div>

<!-- Messages -->
{% if messages %}
<div class="mb-4">
    {% for message in messages %}
    <div class="alert-mobile alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        <div class="d-flex align-items-center">
            {% if message.tags == 'success' %}
                <i class="bi bi-check-circle-fill me-3 fs-5 text-success"></i>
            {% elif message.tags == 'error' %}
                <i class="bi bi-exclamation-triangle-fill me-3 fs-5 text-danger"></i>
            {% endif %}
            <div class="flex-grow-1">{{ message }}</div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- MONTHS_DATA from server -->
<script>
    // Pass month data from Django to JavaScript
    const MONTHS_DATA = {{ months_data_json|safe }};
    console.log('üìä Loaded month data for', Object.keys(MONTHS_DATA).length, 'months');
</script>

<!-- Payment Form -->
<div class="card-mobile mb-4">
    <div class="card-header-mobile">
        <i class="bi bi-plus-circle me-2"></i>
        New Payment Entry
    </div>
    <div class="card-body-mobile">
        <form method="post" id="paymentForm">
            {% csrf_token %}
            
            <!-- Member Selection -->
            <div class="mb-4">
                <label class="form-label fw-bold mb-2">
                    <i class="bi bi-person me-1"></i>
                    Select Member *
                </label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-person-fill"></i>
                    </span>
                    {{ form.member }}
                </div>
                {% if form.member.errors %}
                <div class="text-danger text-small-mobile mt-1">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    {{ form.member.errors }}
                </div>
                {% endif %}
            </div>
            
            <!-- Month Selection -->
            <div class="mb-4">
                <label class="form-label fw-bold mb-2">
                    <i class="bi bi-calendar me-1"></i>
                    Contribution Month *
                </label>
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-calendar-month"></i>
                    </span>
                    {{ form.month }}
                </div>
                {% if form.month.errors %}
                <div class="text-danger text-small-mobile mt-1">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    {{ form.month.errors }}
                </div>
                {% endif %}
                <div class="form-text-help">
                    <i class="bi bi-info-circle me-1"></i>
                    Only unlocked months are shown
                </div>
            </div>
            
            <div class="row g-3 mb-4">
                <!-- Paid Date -->
                <div class="col-md-6">
                    <label class="form-label fw-bold mb-2">
                        <i class="bi bi-calendar-date me-1"></i>
                        Paid Date *
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">
                            <i class="bi bi-calendar-check"></i>
                        </span>
                        {{ form.paid_date }}
                    </div>
                    {% if form.paid_date.errors %}
                    <div class="text-danger text-small-mobile mt-1">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        {{ form.paid_date.errors }}
                    </div>
                    {% endif %}
                </div>
                
                <!-- Amount Paid -->
                <div class="col-md-6">
                    <label class="form-label fw-bold mb-2">
                        <i class="bi bi-currency-exchange me-1"></i>
                        Amount Paid (KSh) *
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">
                            KSh
                        </span>
                        {{ form.amount_paid }}
                    </div>
                    {% if form.amount_paid.errors %}
                    <div class="text-danger text-small-mobile mt-1">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        {{ form.amount_paid.errors }}
                    </div>
                    {% endif %}
                    <div class="form-text-help">
                        <i class="bi bi-info-circle me-1"></i>
                        Default: 2,500 (monthly contribution)
                    </div>
                </div>
            </div>
            
            <!-- Fine Preview -->
            <div class="card border-0 mb-4" id="finePreview" style="display: none;">
                <div class="card-body">
                    <h6 class="fw-bold mb-3">
                        <i class="bi bi-calculator me-2"></i>
                        Fine Calculation Preview
                    </h6>
                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <div class="text-center p-2">
                                <div class="text-muted text-tiny-mobile">Due Date</div>
                                <div class="fw-bold" id="dueDatePreview">-</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-2">
                                <div class="text-muted text-tiny-mobile">Paid Date</div>
                                <div class="fw-bold" id="paidDatePreview">-</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-2">
                                <div class="text-muted text-tiny-mobile">Days Late</div>
                                <div class="fw-bold" id="daysLatePreview">0</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-2">
                                <div class="text-muted text-tiny-mobile">Fine Amount</div>
                                <div class="fw-bold" id="fineAmountPreview">KSh 0</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fine Breakdown -->
                    <div class="row g-2 mb-2" id="fineBreakdown" style="display: none;">
                        <div class="col-6">
                            <div class="bg-light rounded p-2">
                                <div class="text-tiny-mobile text-muted">Early Period</div>
                                <div class="text-small-mobile" id="earlyPeriodPreview"></div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="bg-light rounded p-2">
                                <div class="text-tiny-mobile text-muted">Late Period</div>
                                <div class="text-small-mobile" id="latePeriodPreview"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Fine Note -->
                    <div class="text-center mt-2 text-small-mobile" id="fineNote"></div>
                    
                    <!-- Fine Rules -->
                    <div class="mt-3 text-center">
                        <small class="text-muted text-tiny-mobile">
                            <i class="bi bi-info-circle me-1"></i>
                            Fine rules: Due on 5th of following month. First 5 late days = KSh 100/day, after that = KSh 25/day. Stops on 5th of next month.
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- Submit Buttons -->
            <div class="d-grid gap-2">
                <button type="submit" class="btn btn-primary-mobile btn-mobile" id="submitBtn">
                    <i class="bi bi-check-circle"></i>
                    Record Payment
                </button>
                <a href="{% url 'core:treasurer_dashboard' %}" class="btn btn-outline-secondary btn-mobile">
                    <i class="bi bi-x-circle"></i>
                    Cancel
                </a>
            </div>
            
            <!-- Keyboard Shortcut Hint -->
            <div class="text-center mt-3">
                <small class="text-muted text-tiny-mobile">
                    <i class="bi bi-keyboard me-1"></i>
                    Shortcut: Ctrl + Enter to submit
                </small>
            </div>
        </form>
    </div>
</div>

<!-- Recent Payments -->
<div class="card-mobile">
    <div class="card-header-mobile d-flex align-items-center justify-content-between">
        <div>
            <i class="bi bi-clock-history me-2"></i>
            Recent Payments
        </div>
        <a href="/admin/core/payment/" class="text-white text-decoration-none text-small-mobile">
            View All <i class="bi bi-arrow-right ms-1"></i>
        </a>
    </div>
    <div class="card-body-mobile p-0">
        {% if recent_payments %}
        <div class="list-group list-group-flush">
            {% for payment in recent_payments %}
            <div class="list-group-item border-0 px-3 py-3">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center" 
                            style="width: 40px; height: 40px;">
                            {% if payment.status == 'On Time' %}
                                <i class="bi bi-check-circle text-success"></i>
                            {% elif payment.status == 'Late' %}
                                <i class="bi bi-clock-history text-warning"></i>
                            {% else %}
                                <i class="bi bi-cash text-primary"></i>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <div>
                                <h6 class="fw-bold mb-0">{{ payment.member.user.get_full_name }}</h6>
                                <small class="text-muted text-tiny-mobile">
                                    <i class="bi bi-calendar me-1"></i>
                                    {{ payment.month.month|date:"M Y" }}
                                </small>
                            </div>
                            <span class="badge-mobile 
                                {% if payment.status == 'On Time' %}badge-success-mobile
                                {% elif payment.status == 'Late' %}badge-warning-mobile
                                {% else %}badge-secondary-mobile{% endif %}">
                                {{ payment.status }}
                            </span>
                        </div>
                        <div class="d-flex justify-content-between text-small-mobile mb-1">
                            <span>
                                <i class="bi bi-calendar-check me-1"></i>
                                {{ payment.paid_date|date:"d/m/Y" }}
                            </span>
                            <span class="fw-bold">KSh {{ payment.amount_paid|floatformat:0|intcomma }}</span>
                            {% if payment.fine_amount > 0 %}
                            <span class="text-danger">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                +KSh {{ payment.fine_amount|floatformat:0|intcomma }} fine
                            </span>
                            {% endif %}
                        </div>
                        <div class="text-tiny-mobile text-muted">
                            <i class="bi bi-person-circle me-1"></i>
                            Recorded on {{ payment.recorded_at|date:"d/m/Y H:i" }}
                        </div>
                    </div>
                </div>
            </div>
            {% if not forloop.last %}
            <hr class="my-0 mx-3">
            {% endif %}
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-receipt display-4 text-muted mb-3"></i>
            <p class="text-muted">No recent payments recorded.</p>
            <p class="text-small-mobile text-muted">Start recording payments above.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Quick Tips -->
<div class="card-mobile mt-4">
    <div class="card-body-mobile">
        <h6 class="fw-bold mb-3">
            <i class="bi bi-lightbulb me-2"></i>
            Quick Tips
        </h6>
        <div class="row g-3">
            <div class="col-md-3">
                <div class="text-center p-2">
                    <div class="text-primary mb-1">
                        <i class="bi bi-calendar5 fs-4"></i>
                    </div>
                    <div class="text-tiny-mobile fw-bold">Due Date</div>
                    <div class="text-tiny-mobile">5th of following month</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-2">
                    <div class="text-danger mb-1">
                        <i class="bi bi-100-circle fs-4"></i>
                    </div>
                    <div class="text-tiny-mobile fw-bold">Early Fine</div>
                    <div class="text-tiny-mobile">KSh 100/day (days 1-5)</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-2">
                    <div class="text-warning mb-1">
                        <i class="bi bi-25-circle fs-4"></i>
                    </div>
                    <div class="text-tiny-mobile fw-bold">Late Fine</div>
                    <div class="text-tiny-mobile">KSh 25/day (day 6+)</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center p-2">
                    <div class="text-success mb-1">
                        <i class="bi bi-stop-circle fs-4"></i>
                    </div>
                    <div class="text-tiny-mobile fw-bold">Fine Stop</div>
                    <div class="text-tiny-mobile">5th of next month</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Back Link -->
<div class="d-grid gap-2 mt-4">
    <a href="{% url 'core:treasurer_dashboard' %}" class="btn btn-outline-primary btn-mobile">
        <i class="bi bi-arrow-left"></i>
        Back to Treasurer Dashboard
    </a>
</div>

<!-- Toast Container -->
<div id="toast-container" class="toast-container position-fixed bottom-0 end-0 p-3"></div>

<script>
    // ============================================
    // GLOBAL CONFIGURATION
    // ============================================
    const CONFIG = {
        MONTHLY_CONTRIBUTION: 2500,
        FINE_RATE_EARLY: 100,    // KSh 100/day for first 5 days late
        FINE_RATE_LATE: 25,      // KSh 25/day after 5 days late
        MAX_FINE_DAYS_EARLY: 5,  // First 5 days at 100/day
        STOP_FINING_DAY: 5       // Stop fining on 5th of month after due date
    };
    
    // ============================================
    // MAIN INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üí∞ Payment Entry System Initializing...');
        
        // Initialize components
        initializeElements();
        setupEventListeners();
        setupFormValidation();
        initializePreview();
        
        console.log('‚úÖ Payment Entry System Ready');
    });
    
    // ============================================
    // ELEMENT REFERENCES
    // ============================================
    let elements = {};
    
    function initializeElements() {
        elements = {
            monthSelect: document.querySelector('#id_month'),
            paidDateInput: document.querySelector('#id_paid_date'),
            finePreview: document.getElementById('finePreview'),
            paymentForm: document.getElementById('paymentForm'),
            memberSelect: document.querySelector('#id_member'),
            submitBtn: document.getElementById('submitBtn'),
            
            // Preview elements
            dueDatePreview: document.getElementById('dueDatePreview'),
            paidDatePreview: document.getElementById('paidDatePreview'),
            daysLatePreview: document.getElementById('daysLatePreview'),
            fineAmountPreview: document.getElementById('fineAmountPreview'),
            fineNote: document.getElementById('fineNote'),
            fineBreakdown: document.getElementById('fineBreakdown'),
            earlyPeriodPreview: document.getElementById('earlyPeriodPreview'),
            latePeriodPreview: document.getElementById('latePeriodPreview')
        };
        
        // Validate all required elements exist
        const requiredElements = ['monthSelect', 'paidDateInput', 'paymentForm'];
        requiredElements.forEach(key => {
            if (!elements[key]) {
                console.error(`‚ùå Missing required element: ${key}`);
            }
        });
    }
    
    // ============================================
    // EVENT HANDLERS
    // ============================================
    function setupEventListeners() {
        // Real-time preview updates
        elements.monthSelect?.addEventListener('change', debounce(updateFinePreview, 300));
        elements.paidDateInput?.addEventListener('change', debounce(updateFinePreview, 300));
        elements.paidDateInput?.addEventListener('input', debounce(updateFinePreview, 500));
        
        // Form submission
        elements.paymentForm?.addEventListener('submit', handleFormSubmit);
        
        // Input validation
        elements.memberSelect?.addEventListener('change', validateMemberSelection);
        elements.paidDateInput?.addEventListener('blur', validateDateInput);
        
        // Keyboard shortcuts
        document.addEventListener('keydown', handleKeyboardShortcuts);
    }
    
    function handleKeyboardShortcuts(e) {
        // Ctrl+Enter to submit form
        if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            elements.submitBtn?.click();
        }
        
        // Escape to cancel
        if (e.key === 'Escape') {
            const cancelBtn = document.querySelector('a[href*="treasurer_dashboard"]');
            if (cancelBtn) cancelBtn.click();
        }
    }
    
    // ============================================
    // CORRECT FINE CALCULATION LOGIC
    // ============================================
    /**
     * Calculate fine based on NEW logic:
     * - Contribution month: January 2026
     * - Deadline: February 5, 2026 (5th of FOLLOWING month)
     * - Fine period: February 6, 2026 to March 5, 2026
     * - Stop fining: March 5, 2026
     */
    function calculateFine(dueDate, paidDate) {
        console.group('üßÆ Fine Calculation');
        console.log('Due Date (5th of following month):', dueDate.toLocaleDateString());
        console.log('Paid Date:', paidDate.toLocaleDateString());
        
        // Calculate days late
        const msPerDay = 1000 * 60 * 60 * 24;
        let daysLate = Math.max(0, Math.floor((paidDate - dueDate) / msPerDay));
        
        console.log('Raw days late:', daysLate);
        
        if (daysLate <= 0) {
            console.log('‚úÖ No fine - paid on or before due date');
            console.groupEnd();
            return {
                fine: 0,
                daysLate: 0,
                maxedOut: false,
                stopFiningDate: null,
                fineBreakdown: { earlyDays: 0, lateDays: 0, earlyAmount: 0, lateAmount: 0 }
            };
        }
        
        // ============================================
        // Calculate stop fining date (5th of month AFTER due date month)
        // Example: Due Feb 5 ‚Üí Stop Mar 5
        // ============================================
        let stopFiningYear = dueDate.getFullYear();
        let stopFiningMonth = dueDate.getMonth() + 2; // Month AFTER due date month
        
        // Handle year rollover
        if (stopFiningMonth > 12) {
            stopFiningYear += 1;
            stopFiningMonth -= 12;
        }
        
        const stopFiningDate = new Date(stopFiningYear, stopFiningMonth - 1, CONFIG.STOP_FINING_DAY);
        
        console.log('Stop fining date (5th of month after due date):', stopFiningDate.toLocaleDateString());
        
        // Check if paid after stop date
        const maxedOut = paidDate > stopFiningDate;
        
        // If maxed out, calculate days late only up to stop date
        if (maxedOut) {
            const maxDaysLate = Math.max(0, Math.floor((stopFiningDate - dueDate) / msPerDay));
            daysLate = maxDaysLate;
            console.log('‚ö†Ô∏è Fines maxed out - days capped at:', daysLate, '(stopped on', stopFiningDate.toLocaleDateString() + ')');
        }
        
        // ============================================
        // FINE CALCULATION WITH BREAKDOWN
        // ============================================
        let fineAmount = 0;
        let earlyDays = 0;
        let lateDays = 0;
        let earlyAmount = 0;
        let lateAmount = 0;
        
        if (daysLate <= CONFIG.MAX_FINE_DAYS_EARLY) {
            // Early period only (first 5 days late)
            earlyDays = daysLate;
            earlyAmount = earlyDays * CONFIG.FINE_RATE_EARLY;
            fineAmount = earlyAmount;
            
            console.log(`Early period: ${earlyDays} days √ó KSh ${CONFIG.FINE_RATE_EARLY} = KSh ${earlyAmount}`);
        } else {
            // Both periods (early + late)
            earlyDays = CONFIG.MAX_FINE_DAYS_EARLY;
            lateDays = daysLate - CONFIG.MAX_FINE_DAYS_EARLY;
            
            earlyAmount = earlyDays * CONFIG.FINE_RATE_EARLY;
            lateAmount = lateDays * CONFIG.FINE_RATE_LATE;
            fineAmount = earlyAmount + lateAmount;
            
            console.log(`Early period: ${earlyDays} days √ó KSh ${CONFIG.FINE_RATE_EARLY} = KSh ${earlyAmount}`);
            console.log(`Late period: ${lateDays} days √ó KSh ${CONFIG.FINE_RATE_LATE} = KSh ${lateAmount}`);
            console.log(`Total fine: KSh ${earlyAmount} + KSh ${lateAmount} = KSh ${fineAmount}`);
        }
        
        const result = {
            fine: fineAmount,
            daysLate: daysLate,
            maxedOut: maxedOut,
            stopFiningDate: stopFiningDate,
            fineBreakdown: {
                earlyDays: earlyDays,
                lateDays: lateDays,
                earlyAmount: earlyAmount,
                lateAmount: lateAmount
            }
        };
        
        console.log('üéØ Final result:', result);
        console.groupEnd();
        
        return result;
    }
    
    // ============================================
    // DATE VALIDATION
    // ============================================
    function validateDateInput() {
        const input = elements.paidDateInput;
        if (!input || !input.value) return true;
        
        const selectedDate = new Date(input.value);
        selectedDate.setHours(0, 0, 0, 0);
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (selectedDate > today) {
            showToast('‚ö†Ô∏è Payment date cannot be in the future', 'warning');
            input.value = today.toISOString().split('T')[0];
            updateFinePreview();
            return false;
        }
        
        return true;
    }
    
    // ============================================
    // PREVIEW SYSTEM
    // ============================================
    function initializePreview() {
        // Set default paid date to today if empty
        if (elements.paidDateInput && !elements.paidDateInput.value) {
            const today = new Date().toISOString().split('T')[0];
            elements.paidDateInput.value = today;
            console.log('üìÖ Set default date:', today);
        }
        
        // Initial preview update
        setTimeout(updateFinePreview, 200);
    }
    
    async function updateFinePreview() {
        console.group('üîÑ Updating Fine Preview');
        
        const monthId = elements.monthSelect?.value;
        const paidDateStr = elements.paidDateInput?.value;
        
        console.log('Inputs:', { monthId, paidDateStr });
        
        // Validate inputs
        if (!monthId || !paidDateStr) {
            console.log('‚ùå Missing inputs, hiding preview');
            hidePreview();
            console.groupEnd();
            return;
        }
        
        // Validate date
        const paidDate = new Date(paidDateStr);
        if (isNaN(paidDate.getTime())) {
            console.error('‚ùå Invalid date:', paidDateStr);
            hidePreview();
            console.groupEnd();
            return;
        }
        
        // Get month info from MONTHS_DATA
        const monthInfo = MONTHS_DATA[monthId];
        if (!monthInfo) {
            console.error('‚ùå Month not found in MONTHS_DATA:', monthId);
            hidePreview();
            console.groupEnd();
            return;
        }
        
        const dueDate = new Date(monthInfo.due_date);
        console.log('Retrieved due date:', dueDate.toLocaleDateString());
        
        // Calculate fine
        const result = calculateFine(dueDate, paidDate);
        
        // Update preview display
        updatePreviewDisplay(monthInfo, result, paidDate);
        
        console.groupEnd();
    }
    
    function updatePreviewDisplay(monthInfo, result, paidDate) {
        // Update basic info
        if (elements.dueDatePreview) {
            elements.dueDatePreview.textContent = formatDate(new Date(monthInfo.due_date));
            elements.dueDatePreview.className = result.daysLate > 0 ? 'fw-bold text-danger' : 'fw-bold text-success';
        }
        
        if (elements.paidDatePreview) {
            elements.paidDatePreview.textContent = formatDate(paidDate);
        }
        
        if (elements.daysLatePreview) {
            elements.daysLatePreview.textContent = result.daysLate;
            elements.daysLatePreview.className = result.daysLate > 0 ? 'fw-bold text-danger' : 'fw-bold text-success';
        }
        
        if (elements.fineAmountPreview) {
            elements.fineAmountPreview.textContent = `KSh ${result.fine.toLocaleString()}`;
            elements.fineAmountPreview.className = result.fine > 0 ? 'fw-bold text-danger' : 'fw-bold text-success';
        }
        
        // Update fine breakdown
        updateFineBreakdown(result);
        
        // Update fine note
        updateFineNote(result, new Date(monthInfo.due_date));
        
        // Style the preview card
        stylePreviewCard(result);
        
        // Show the preview
        showPreview();
    }
    
    function updateFineBreakdown(result) {
        if (!elements.fineBreakdown) return;
        
        const breakdown = result.fineBreakdown;
        
        if (result.fine === 0) {
            elements.fineBreakdown.style.display = 'none';
            return;
        }
        
        elements.fineBreakdown.style.display = 'flex';
        
        if (elements.earlyPeriodPreview) {
            if (breakdown.earlyDays > 0) {
                elements.earlyPeriodPreview.innerHTML = `
                    <div class="fw-bold">${breakdown.earlyDays} days</div>
                    <div class="text-tiny-mobile">KSh ${CONFIG.FINE_RATE_EARLY}/day</div>
                    <div class="fw-bold text-danger">KSh ${breakdown.earlyAmount}</div>
                `;
            } else {
                elements.earlyPeriodPreview.innerHTML = '<div class="text-muted">No early fine</div>';
            }
        }
        
        if (elements.latePeriodPreview) {
            if (breakdown.lateDays > 0) {
                elements.latePeriodPreview.innerHTML = `
                    <div class="fw-bold">${breakdown.lateDays} days</div>
                    <div class="text-tiny-mobile">KSh ${CONFIG.FINE_RATE_LATE}/day</div>
                    <div class="fw-bold text-warning">KSh ${breakdown.lateAmount}</div>
                `;
            } else {
                elements.latePeriodPreview.innerHTML = '<div class="text-muted">No late fine</div>';
            }
        }
    }
    
    function updateFineNote(result, dueDate) {
        if (!elements.fineNote) return;
        
        let noteHTML = '';
        
        if (result.fine === 0) {
            noteHTML = `<span class="text-success">
                <i class="bi bi-check-circle me-1"></i>
                Paid on time (before ${formatDate(dueDate)})
            </span>`;
        } else if (result.maxedOut) {
            noteHTML = `<span class="text-warning">
                <i class="bi bi-exclamation-triangle me-1"></i>
                Fines stopped on ${formatDate(result.stopFiningDate)} (maximum fine reached)
            </span>`;
        } else {
            const breakdown = result.fineBreakdown;
            noteHTML = `<span class="text-danger">
                <i class="bi bi-calculator me-1"></i>
                Fine calculated for ${result.daysLate} late day${result.daysLate !== 1 ? 's' : ''}
            </span>`;
        }
        
        elements.fineNote.innerHTML = noteHTML;
    }
    
    function stylePreviewCard(result) {
        if (!elements.finePreview) return;
        
        // Reset styles
        elements.finePreview.classList.remove('border-success', 'border-warning', 'border-danger');
        
        if (result.fine === 0) {
            elements.finePreview.classList.add('border-success');
            elements.finePreview.style.backgroundColor = 'rgba(25, 135, 84, 0.05)';
        } else if (result.maxedOut) {
            elements.finePreview.classList.add('border-warning');
            elements.finePreview.style.backgroundColor = 'rgba(255, 193, 7, 0.05)';
        } else if (result.fine > 500) {
            elements.finePreview.classList.add('border-danger');
            elements.finePreview.style.backgroundColor = 'rgba(220, 53, 69, 0.05)';
        } else {
            elements.finePreview.classList.add('border-warning');
            elements.finePreview.style.backgroundColor = 'rgba(255, 193, 7, 0.05)';
        }
    }
    
    function showPreview() {
        if (elements.finePreview) {
            elements.finePreview.style.display = 'block';
            elements.finePreview.style.opacity = '0';
            elements.finePreview.style.transition = 'opacity 0.3s ease';
            
            setTimeout(() => {
                elements.finePreview.style.opacity = '1';
            }, 10);
        }
    }
    
    function hidePreview() {
        if (elements.finePreview) {
            elements.finePreview.style.opacity = '0';
            setTimeout(() => {
                elements.finePreview.style.display = 'none';
            }, 300);
        }
    }
    
    // ============================================
    // FORM VALIDATION & SUBMISSION
    // ============================================
    function setupFormValidation() {
        const inputs = [elements.memberSelect, elements.monthSelect, elements.paidDateInput];
        
        inputs.forEach(input => {
            if (!input) return;
            
            input.addEventListener('blur', function() {
                if (this.value) {
                    this.classList.remove('is-invalid');
                    this.classList.add('is-valid');
                } else {
                    this.classList.remove('is-valid');
                    this.classList.add('is-invalid');
                }
            });
        });
    }
    
    function validateMemberSelection() {
        if (!elements.memberSelect) return true;
        
        if (!elements.memberSelect.value) {
            showToast('‚ö†Ô∏è Please select a member', 'warning');
            return false;
        }
        
        return true;
    }
    
    async function handleFormSubmit(e) {
        e.preventDefault();
        console.group('üìã Form Submission');
        
        // Show loading state
        const originalText = elements.submitBtn.innerHTML;
        elements.submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
        elements.submitBtn.disabled = true;
        
        try {
            // Basic validation
            if (!validateForm()) {
                throw new Error('Form validation failed');
            }
            
            // Get month info for confirmation
            const monthId = elements.monthSelect.value;
            const monthInfo = MONTHS_DATA[monthId];
            
            if (monthInfo) {
                const dueDate = new Date(monthInfo.due_date);
                const paidDate = new Date(elements.paidDateInput.value);
                const result = calculateFine(dueDate, paidDate);
                
                // Show confirmation dialog
                if (!await showConfirmationDialog(monthInfo, result, paidDate)) {
                    throw new Error('User cancelled submission');
                }
            }
            
            // Submit the form
            console.log('‚úÖ Submitting form...');
            elements.paymentForm.submit();
            
        } catch (error) {
            console.error('Submission error:', error);
            if (error.message !== 'User cancelled submission') {
                showToast(`Error: ${error.message}`, 'error');
            }
        } finally {
            // Restore button
            elements.submitBtn.innerHTML = originalText;
            elements.submitBtn.disabled = false;
            console.groupEnd();
        }
    }
    
    function validateForm() {
        let isValid = true;
        const errors = [];
        
        if (!elements.memberSelect?.value) {
            errors.push('Please select a member');
            isValid = false;
        }
        
        if (!elements.monthSelect?.value) {
            errors.push('Please select a contribution month');
            isValid = false;
        }
        
        if (!elements.paidDateInput?.value) {
            errors.push('Please select a payment date');
            isValid = false;
        }
        
        // Date validation
        if (elements.paidDateInput?.value) {
            const selectedDate = new Date(elements.paidDateInput.value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (selectedDate > today) {
                errors.push('Payment date cannot be in the future');
                isValid = false;
            }
        }
        
        // Show errors if any
        if (errors.length > 0) {
            showToast(errors.join('<br>'), 'error');
        }
        
        return isValid;
    }
    
    async function showConfirmationDialog(monthInfo, fineResult, paidDate) {
        const memberName = getSelectedMemberName();
        const amountPaid = document.querySelector('#id_amount_paid')?.value || CONFIG.MONTHLY_CONTRIBUTION;
        const totalAmount = parseInt(amountPaid) + fineResult.fine;
        
        let message = `<div class="text-start">`;
        message += `<h6 class="fw-bold mb-3">Confirm Payment Details</h6>`;
        message += `<div class="mb-2"><strong>Member:</strong> ${memberName}</div>`;
        message += `<div class="mb-2"><strong>Contribution Month:</strong> ${monthInfo.month_name}</div>`;
        message += `<div class="mb-2"><strong>Due Date:</strong> ${formatDate(new Date(monthInfo.due_date))}</div>`;
        message += `<div class="mb-2"><strong>Paid Date:</strong> ${formatDate(paidDate)}</div>`;
        message += `<div class="mb-2"><strong>Days Late:</strong> <span class="${fineResult.daysLate > 0 ? 'text-danger fw-bold' : 'text-success'}">${fineResult.daysLate}</span></div>`;
        
        if (fineResult.fine > 0) {
            message += `<div class="mb-2"><strong>Fine Amount:</strong> <span class="text-danger fw-bold">KSh ${fineResult.fine.toLocaleString()}</span></div>`;
            
            if (fineResult.fineBreakdown.lateDays > 0) {
                message += `<div class="small text-muted mb-2">`;
                message += `(KSh ${fineResult.fineBreakdown.earlyAmount} for first ${fineResult.fineBreakdown.earlyDays} days`;
                message += ` + KSh ${fineResult.fineBreakdown.lateAmount} for next ${fineResult.fineBreakdown.lateDays} days)`;
                message += `</div>`;
            }
            
            if (fineResult.maxedOut) {
                message += `<div class="small text-warning mb-2">`;
                message += `<i class="bi bi-exclamation-triangle me-1"></i>`;
                message += `Maximum fine reached (stopped on ${formatDate(fineResult.stopFiningDate)})`;
                message += `</div>`;
            }
        }
        
        message += `<hr>`;
        message += `<div class="mb-2"><strong>Monthly Contribution:</strong> KSh ${parseInt(amountPaid).toLocaleString()}</div>`;
        
        if (fineResult.fine > 0) {
            message += `<div class="mb-2"><strong>Fine:</strong> KSh ${fineResult.fine.toLocaleString()}</div>`;
        }
        
        message += `<div class="fw-bold fs-5 text-primary">`;
        message += `Total Amount: KSh ${totalAmount.toLocaleString()}`;
        message += `</div>`;
        message += `<div class="small text-muted mt-2">Status: ${fineResult.daysLate > 0 ? 'Late' : 'On Time'}</div>`;
        message += `</div>`;
        
        // Use SweetAlert2 if available
        if (typeof Swal !== 'undefined') {
            return Swal.fire({
                title: 'Confirm Payment Recording',
                html: message,
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Yes, Record Payment',
                cancelButtonText: 'Cancel',
                confirmButtonColor: '#4361ee',
                cancelButtonColor: '#6c757d',
                showClass: { popup: 'animate__animated animate__fadeInDown' },
                hideClass: { popup: 'animate__animated animate__fadeOutUp' }
            }).then((result) => {
                return result.isConfirmed;
            });
        }
        
        // Fallback to native confirm
        return confirm(`Record this payment?\n\nMember: ${memberName}\nMonth: ${monthInfo.month_name}\nDue: ${formatDate(new Date(monthInfo.due_date))}\nPaid: ${formatDate(paidDate)}\nDays Late: ${fineResult.daysLate}\nFine: KSh ${fineResult.fine}\nTotal: KSh ${totalAmount}`);
    }
    
    function getSelectedMemberName() {
        if (!elements.memberSelect) return 'Unknown Member';
        
        const selectedOption = elements.memberSelect.options[elements.memberSelect.selectedIndex];
        return selectedOption.text || 'Unknown Member';
    }
    
    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    function formatDate(date) {
        if (!date) return '-';
        return date.toLocaleDateString('en-GB', {
            day: 'numeric',
            month: 'short',
            year: 'numeric'
        });
    }
    
    function showToast(message, type = 'info') {
        const toastId = 'payment-toast-' + Date.now();
        const toastHtml = `
            <div id="${toastId}" class="toast align-items-center text-bg-${type} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;
        
        const container = document.getElementById('toast-container');
        if (container) {
            container.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastEl = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastEl, { delay: 4000 });
            toast.show();
            
            toastEl.addEventListener('hidden.bs.toast', function() {
                this.remove();
            });
        }
    }
    
    // ============================================
    // ERROR HANDLING
    // ============================================
    window.addEventListener('error', function(e) {
        console.error('Global error:', e.error);
        showToast('An error occurred. Please check the console.', 'error');
    });
    
    // ============================================
    // MONTHS_DATA FALLBACK
    // ============================================
    if (typeof MONTHS_DATA === 'undefined' || Object.keys(MONTHS_DATA).length === 0) {
        console.warn('MONTHS_DATA not provided by server. Building fallback...');
        MONTHS_DATA = {};
        
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (elements.monthSelect) {
                    console.log('Building fallback MONTHS_DATA from form options...');
                    Array.from(elements.monthSelect.options).forEach(option => {
                        if (option.value) {
                            // Parse month from option text (e.g., "January 2025")
                            const match = option.text.match(/(\w+)\s+(\d{4})/);
                            if (match) {
                                const monthName = match[1];
                                const year = parseInt(match[2]);
                                const monthMap = {
                                    'January': 0, 'February': 1, 'March': 2, 'April': 3,
                                    'May': 4, 'June': 5, 'July': 6, 'August': 7,
                                    'September': 8, 'October': 9, 'November': 10, 'December': 11
                                };
                                
                                if (monthMap[monthName] !== undefined) {
                                    // NEW LOGIC: Due date is 5th of FOLLOWING month
                                    let dueMonth = monthMap[monthName] + 1;
                                    let dueYear = year;
                                    
                                    if (dueMonth > 11) {
                                        dueMonth = 0;
                                        dueYear += 1;
                                    }
                                    
                                    const dueDate = new Date(dueYear, dueMonth, 5);
                                    MONTHS_DATA[option.value] = {
                                        due_date: dueDate.toISOString(),
                                        month_date: new Date(year, monthMap[monthName], 1).toISOString(),
                                        month_name: option.text
                                    };
                                }
                            }
                        }
                    });
                    console.log('Fallback MONTHS_DATA built:', MONTHS_DATA);
                    updateFinePreview(); // Refresh preview with new data
                }
            }, 1000);
        });
    }
</script>

<style>
    /* Additional mobile optimizations */
    @media (max-width: 768px) {
        .text-tiny-mobile {
            font-size: 0.75rem !important;
        }
        
        .btn-mobile {
            padding: 0.5rem 1rem !important;
            font-size: 0.9rem !important;
        }
        
        .card-body-mobile {
            padding: 1rem !important;
        }
        
        .input-group-text {
            padding: 0.375rem 0.75rem !important;
        }
        
        select.form-control, input.form-control {
            padding: 0.375rem 0.75rem !important;
            font-size: 0.9rem !important;
        }
    }
    
    /* Form validation styles */
    .is-valid {
        border-color: #198754 !important;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e") !important;
        background-repeat: no-repeat !important;
        background-position: right calc(0.375em + 0.1875rem) center !important;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem) !important;
    }
    
    .is-invalid {
        border-color: #dc3545 !important;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e") !important;
        background-repeat: no-repeat !important;
        background-position: right calc(0.375em + 0.1875rem) center !important;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem) !important;
    }
    
    /* Animation for fine preview */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    #finePreview {
        animation: fadeIn 0.3s ease-out;
    }
    
    /* Better focus states */
    .form-control:focus, .form-select:focus {
        border-color: #4361ee;
        box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
    }
</style>

{% endblock %}